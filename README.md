# Phabricator Remarkup Editor Plugin

This is a simple plugin that adds a button to the Phabricator Remarkup editor that allows you to edit the raw Remarkup text in full-screen mode.

## Security
- No additional package is required.
- Only inject CSS and JavaScript code into the current page.
- Volatile, the code will be removed after you refresh the page.
- No data is collected or sent to any server.

## Usage
- **!! Important !!** Currently, only `Task Maniphest`, `Events`, `Comment Editor`, and `New Comment` are supported.
- **!! Important !!** For the use case in `New Comment`, you need to type some text in the editor to show the preview panel before you can use the full-screen editor mode.
- **!! Important !!** For the use case in `Events`, the preview does not update automatically when you type in the editor. You need to re-open the full-screen editor mode to see the updated preview.

## Features
- Half screen mode
- Hot key for 
    - `ctrl-b`: make selected text bold (only in editor)
    - `ctrl-i`: make selected text italic (only in editor)
    - `: add a code block (only in editor) 
    - `Tab`: add 2 spaces to the beginning of each selected line (only in editor)
- Find and replace toolbox, including
    - Case sensitive / insensitive
    - Match whole world
    - Replace one / all

## Install on Your Bookmark
<!-- Set the bookmark row to visible -->
1. First, you need to make the bookmark row of your browser visible. In Chrome, you can do this by clicking the three-dot icon at the top right corner, selecting "Bookmarks" (書籤), and then selecting "Show bookmarks bar" (顯示書籤列).
2.  Drag this link 
<a href='javascript:(()=>{var editor_styles = `.editor-height-full {height: 100vh !important;}.editor-height-half {height: 50vh !important;}.editor-left-col {display: block;position: fixed;z-index: 15;left: 0;bottom: 0;width: 50%;iiheight: 100vh;}.editor-left-col textarea {display: block !important;height: 100% !important;background-color: rgba(250,250,250,1.0) !important;}.editor-right-col {display: block;position: fixed;z-index: 15;left: 50%;bottom: 0;width: 50%;overflow-y: scroll;background-color: rgba(250,250,250,1.0);}.editor-btn {z-index: 20;position: fixed;padding: 0;width: 50px;height: 50px;border-radius: 50%;opacity: 0.7;}.editor-btn p {text-align: center;}#editor-enter-btn {right: 50px;top: 50px;}#editor-size-btn {right: 120px;top: 50px;}.editor-move-down {position: fixed;bottom: 0;}`;var styleSheet = document.createElement("style");styleSheet.innerText = editor_styles;document.head.appendChild(styleSheet);function SetRemarkupPreview(preview_state) {   const num_btn = document.querySelectorAll("div.fa-eye").length;var PreviewBtn = document.querySelectorAll("div.fa-eye")[num_btn-1].parentElement;if (PreviewBtn == null) return null;const current_state = PreviewBtn.classList.contains("preview-active");if (preview_state != current_state) {PreviewBtn.click();}return PreviewBtn;}class EditorMode {static None = new EditorMode("None");static Normal = new EditorMode("Normal");static Task = new EditorMode("Task");static Event = new EditorMode("Event");static BlockEditor = new EditorMode("BlockEditor");static NewComment = new EditorMode("NewComment");constructor(name) {this.name = name;}}class EditorStyle {static Full = new EditorStyle("Full", "editor-height-full");static Half = new EditorStyle("Half", "editor-height-half");constructor(name, style_name) {this.name = name;this.style_name = style_name;}}function GetRemarkupElement() {var assist_bar = document.getElementsByClassName("remarkup-assist-bar");const edit_mode = (assist_bar.length > 1) ? EditorMode.BlockEditor : EditorMode.Normal;var targetRemarkUpElement = assist_bar[assist_bar.length-1].parentElement;targetRemarkUpElement.querySelector("textarea").focus();  return [edit_mode, targetRemarkUpElement];}function GetPreviewElement(edit_mode) {   if (edit_mode.name === EditorMode.Normal.name) {   if (document.getElementsByClassName("phui-comment-preview-view").length > 0) {   return document.getElementsByClassName("phui-comment-preview-view")[0].querySelector("div.phui-timeline-view");} else if (document.getElementsByClassName("phui-remarkup-preview").length > 0) {   return document.getElementsByClassName("phui-remarkup-preview")[0];}}   if (SetRemarkupPreview(true) !== null) {  if (document.getElementsByClassName("remarkup-inline-preview").length > 0)return document.getElementsByClassName("remarkup-inline-preview")[0];} return null;}function HideOriginalEditor(hide) {var mask = document.getElementsByClassName("jx-mask")[0];var originalEditor = document.getElementsByClassName("jx-client-dialog")[0];if (hide) {mask.style.display = "none";originalEditor.classList.add("editor-move-down");} else {mask.style.display = "block";originalEditor.classList.remove("editor-move-down");}}var editor_mode = "normal";var editor_style = EditorStyle.Full;var EditorEnterBtn = document.createElement("button");EditorEnterBtn.setAttribute("id", "editor-enter-btn");EditorEnterBtn.classList.add("editor-btn");EditorEnterBtn.innerHTML = `<p id="editor-text">Edit</p>`;EditorEnterBtn.onclick = (evt)=>{var [edit_mode, RemarkupElement] = GetRemarkupElement();var PreviewElement = GetPreviewElement(edit_mode);if (RemarkupElement === null || PreviewElement === null) {alert("Current page does not support editor mode!");return;}if (editor_mode === "normal") {editor_mode = "editor";RemarkupElement.classList.add("editor-left-col");RemarkupElement.classList.add(editor_style.style_name);   RemarkupElement.classList.remove("remarkup-preview-active");PreviewElement.classList.add("editor-right-col");PreviewElement.classList.add(editor_style.style_name);document.getElementById("editor-text").innerText = "Back";   if (edit_mode === EditorMode.BlockEditor) {HideOriginalEditor(true);}} else {editor_mode = "normal";RemarkupElement.classList.remove("editor-left-col");RemarkupElement.classList.remove(editor_style.style_name);PreviewElement.classList.remove("editor-right-col");PreviewElement.classList.remove(editor_style.style_name);document.getElementById("editor-text").innerText = "Edit";   SetRemarkupPreview(false);   if (edit_mode === EditorMode.BlockEditor) {HideOriginalEditor(false);}}};var EditorSizeBtn = document.createElement("button");EditorSizeBtn.setAttribute("id", "editor-size-btn");EditorSizeBtn.classList.add("editor-btn");EditorSizeBtn.innerHTML = `<p id="editor-size-text">Half<br>Size</p>`;EditorSizeBtn.onclick = (evt)=>{var [edit_mode, RemarkupElement] = GetRemarkupElement();var PreviewElement = GetPreviewElement(edit_mode);RemarkupElement.classList.remove(editor_style.style_name);PreviewElement.classList.remove(editor_style.style_name);   editor_style = (editor_style === EditorStyle.Full) ? EditorStyle.Half : EditorStyle.Full;EditorSizeBtn.innerText = editor_style.name;RemarkupElement.classList.add(editor_style.style_name);PreviewElement.classList.add(editor_style.style_name);};document.body.appendChild(EditorEnterBtn);document.body.appendChild(EditorSizeBtn);(() => {const findReplaceDiv = document.createElement("div");findReplaceDiv.innerHTML = `<div id="find-replace-box" class="find-replace-box"><input type="text" id="find-input" class="find-input" placeholder="Find"><div title="Case sensitive"><p>|Aa|</p><label class="switch"><input id="capital-switch" type="checkbox"><span class="slider round"></span></label></div><div title="Match whole word"><p>[Aa]</p><label class="switch"><input id="whole-word-switch" type="checkbox"><span class="slider round"></span></label></div><button id="find-btn" class="find-btn">Find</button><input type="text" id="replace-input" class="replace-input" placeholder="Replace"><div title="Replace All"><p>All</p><label class="switch"><input id="match-all-switch" type="checkbox"><span class="slider round"></span></label></div><button id="replace-btn" class="replace-btn">Replace</button></div>`;document.body.appendChild(findReplaceDiv);  const findReplaceStyles = `.find-replace-box {position: fixed;z-index: 100;bottom: 0;left: 0;padding: 5px;background-color: white;border: 1px solid #ccc;border-radius: 5px;}.find-replace-box div {display: inline-block;position: relative;bottom: -8px;}.find-input, .replace-input {padding: 2px;margin: 2px;}.find-btn, .replace-btn {padding: 2px;margin: 2px;}.switch {position: relative;display: inline-block;width: 32px;height: 18px;}  .switch input { opacity: 0;width: 0;height: 0;}  .slider {position: absolute;cursor: pointer;top: 0;left: 0;right: 0;bottom: 0;background-color: #ccc;-webkit-transition: .4s;transition: .4s;}.slider:before {position: absolute;content: "";height: 10px;width: 10px;left: 4px;bottom: 4px;background-color: white;-webkit-transition: .4s;transition: .4s;}  input:checked + .slider {background-color: #2196F3;}  input:focus + .slider {box-shadow: 0 0 1px #2196F3;  }  input:checked + .slider:before {-webkit-transform: translateX(13px);-ms-transform: translateX(13px);transform: translateX(13px);}  .slider.round {border-radius: 17px;}  .slider.round:before {border-radius: 50%;}`;const findReplaceStyleSheet = document.createElement("style");findReplaceStyleSheet.innerText = findReplaceStyles;document.head.appendChild(findReplaceStyleSheet);   const findBtn = document.getElementById("find-btn");const replaceBtn = document.getElementById("replace-btn");function getSearchRegex (findText) {   const caseSensitive = document.getElementById("capital-switch").checked;const wholeWord = document.getElementById("whole-word-switch").checked;const flags = caseSensitive ? "g" : "gi";return new RegExp(wholeWord ? `\\b${findText}\\b` : findText, flags);};findBtn.onclick = () => {var textarea = GetRemarkupElement()[1].querySelector("textarea");const findText = document.getElementById("find-input").value;const text = textarea.value;var searchRegex = getSearchRegex(findText);if (searchRegex.test(text)) {const position = text.search(searchRegex);textarea.setSelectionRange(position, position + findText.length);}};replaceBtn.onclick = () => {var textarea = GetRemarkupElement()[1].querySelector("textarea");const findText = document.getElementById("find-input").value;const replaceText = document.getElementById("replace-input").value;const matchAll = document.getElementById("match-all-switch").checked;var searchRegex = getSearchRegex(findText);const text = textarea.value;if (searchRegex.test(text)) {if (matchAll) {   textarea.value = text.replace(searchRegex, replaceText);} else {const position = text.search(searchRegex);textarea.setRangeText(replaceText, position, position + findText.length, 'select');}}};})();const insertText = (textarea, token) => {const position = textarea.selectionStart;   const start = textarea.selectionStart;const end = textarea.selectionEnd;const text = token + window.getSelection().toString() + token;textarea.setRangeText(text, start, end, 'select');};window.addEventListener("keydown", (event) => {if (document.activeElement.type == 'textarea' ){  let textarea = document.activeElement;if(event.ctrlKey && event.key === 'b') {insertText(textarea, '**');event.preventDefault(); } else if(event.ctrlKey && event.key == 'i') { insertText(textarea, '//');event.preventDefault(); } else if(event.ctrlKey && event.key == 'f') {} else if (event.key == '`') {insertText(textarea, '`');event.preventDefault();} else if(event.key == 'Tab') {var start = textarea.selectionStart;   while (start > 0 && textarea.value[start] != '\n') {start--;}const end = textarea.selectionEnd;const text = textarea.value;const selectedText = text.substring(start, end);const newText = selectedText.split('\n').map(line => '  ' + line).join('\n');textarea.setRangeText(newText, start, end, 'select');event.preventDefault(); }}});(()=>{   const blockIdStyles = `.phui-timeline-extra .block-id {margin-left: 5px;border: 1px solid #ccc;border-radius: 3px;}.phui-timeline-extra .block-id:hover {cursor: pointer;}.phui-timeline-extra .block-id.show-copied {background-color: #4CAF50;padding-left: 2px;padding-right: 2px;color: white;}`;const blockIdStyleSheet = document.createElement("style");blockIdStyleSheet.innerText = blockIdStyles;document.head.appendChild(blockIdStyleSheet);var timeline_extra = document.querySelectorAll('.phui-timeline-extra');for (var i = 0; i < timeline_extra.length; i++) {var stamp_element = timeline_extra[i].querySelector('a');   var href = stamp_element.getAttribute('href');   var span = document.createElement('span');span.classList.add('block-id');span.innerText = href;span.setAttribute('title', 'Copy to clipboard');   span.onclick = (evt) => {const href = evt.target.innerText;navigator.clipboard.writeText(href);   evt.target.innerText = 'Copied!';evt.target.classList.add('show-copied');setTimeout(() => {evt.target.innerText = href;evt.target.classList.remove('show-copied');}, 1000);};timeline_extra[i].appendChild(span);};})()})()'>Edit</a>,
to the bookmark bar of your browser. 
    - (Alternatively), Right-click on the space of the bookmark bar. Click "Add page" (新增網頁).
    - You can copy the following code: 
        ```
        javascript:(()=>{var editor_styles = `.editor-height-full {height: 100vh !important;}.editor-height-half {height: 50vh !important;}.editor-left-col {display: block;position: fixed;z-index: 15;left: 0;bottom: 0;width: 50%;iiheight: 100vh;}.editor-left-col textarea {display: block !important;height: 100% !important;background-color: rgba(250,250,250,1.0) !important;}.editor-right-col {display: block;position: fixed;z-index: 15;left: 50%;bottom: 0;width: 50%;overflow-y: scroll;background-color: rgba(250,250,250,1.0);}.editor-btn {z-index: 20;position: fixed;padding: 0;width: 50px;height: 50px;border-radius: 50%;opacity: 0.7;}.editor-btn p {text-align: center;}#editor-enter-btn {right: 50px;top: 50px;}#editor-size-btn {right: 120px;top: 50px;}.editor-move-down {position: fixed;bottom: 0;}`;var styleSheet = document.createElement("style");styleSheet.innerText = editor_styles;document.head.appendChild(styleSheet);function SetRemarkupPreview(preview_state) {   const num_btn = document.querySelectorAll("div.fa-eye").length;var PreviewBtn = document.querySelectorAll("div.fa-eye")[num_btn-1].parentElement;if (PreviewBtn == null) return null;const current_state = PreviewBtn.classList.contains("preview-active");if (preview_state != current_state) {PreviewBtn.click();}return PreviewBtn;}class EditorMode {static None = new EditorMode("None");static Normal = new EditorMode("Normal");static Task = new EditorMode("Task");static Event = new EditorMode("Event");static BlockEditor = new EditorMode("BlockEditor");static NewComment = new EditorMode("NewComment");constructor(name) {this.name = name;}}class EditorStyle {static Full = new EditorStyle("Full", "editor-height-full");static Half = new EditorStyle("Half", "editor-height-half");constructor(name, style_name) {this.name = name;this.style_name = style_name;}}function GetRemarkupElement() {var assist_bar = document.getElementsByClassName("remarkup-assist-bar");const edit_mode = (assist_bar.length > 1) ? EditorMode.BlockEditor : EditorMode.Normal;var targetRemarkUpElement = assist_bar[assist_bar.length-1].parentElement;targetRemarkUpElement.querySelector("textarea").focus();  return [edit_mode, targetRemarkUpElement];}function GetPreviewElement(edit_mode) {   if (edit_mode.name === EditorMode.Normal.name) {   if (document.getElementsByClassName("phui-comment-preview-view").length > 0) {   return document.getElementsByClassName("phui-comment-preview-view")[0].querySelector("div.phui-timeline-view");} else if (document.getElementsByClassName("phui-remarkup-preview").length > 0) {   return document.getElementsByClassName("phui-remarkup-preview")[0];}}   if (SetRemarkupPreview(true) !== null) {  if (document.getElementsByClassName("remarkup-inline-preview").length > 0)return document.getElementsByClassName("remarkup-inline-preview")[0];} return null;}function HideOriginalEditor(hide) {var mask = document.getElementsByClassName("jx-mask")[0];var originalEditor = document.getElementsByClassName("jx-client-dialog")[0];if (hide) {mask.style.display = "none";originalEditor.classList.add("editor-move-down");} else {mask.style.display = "block";originalEditor.classList.remove("editor-move-down");}}var editor_mode = "normal";var editor_style = EditorStyle.Full;var EditorEnterBtn = document.createElement("button");EditorEnterBtn.setAttribute("id", "editor-enter-btn");EditorEnterBtn.classList.add("editor-btn");EditorEnterBtn.innerHTML = `<p id="editor-text">Edit</p>`;EditorEnterBtn.onclick = (evt)=>{var [edit_mode, RemarkupElement] = GetRemarkupElement();var PreviewElement = GetPreviewElement(edit_mode);if (RemarkupElement === null || PreviewElement === null) {alert("Current page does not support editor mode!");return;}if (editor_mode === "normal") {editor_mode = "editor";RemarkupElement.classList.add("editor-left-col");RemarkupElement.classList.add(editor_style.style_name);   RemarkupElement.classList.remove("remarkup-preview-active");PreviewElement.classList.add("editor-right-col");PreviewElement.classList.add(editor_style.style_name);document.getElementById("editor-text").innerText = "Back";   if (edit_mode === EditorMode.BlockEditor) {HideOriginalEditor(true);}} else {editor_mode = "normal";RemarkupElement.classList.remove("editor-left-col");RemarkupElement.classList.remove(editor_style.style_name);PreviewElement.classList.remove("editor-right-col");PreviewElement.classList.remove(editor_style.style_name);document.getElementById("editor-text").innerText = "Edit";   SetRemarkupPreview(false);   if (edit_mode === EditorMode.BlockEditor) {HideOriginalEditor(false);}}};var EditorSizeBtn = document.createElement("button");EditorSizeBtn.setAttribute("id", "editor-size-btn");EditorSizeBtn.classList.add("editor-btn");EditorSizeBtn.innerHTML = `<p id="editor-size-text">Half<br>Size</p>`;EditorSizeBtn.onclick = (evt)=>{var [edit_mode, RemarkupElement] = GetRemarkupElement();var PreviewElement = GetPreviewElement(edit_mode);RemarkupElement.classList.remove(editor_style.style_name);PreviewElement.classList.remove(editor_style.style_name);   editor_style = (editor_style === EditorStyle.Full) ? EditorStyle.Half : EditorStyle.Full;EditorSizeBtn.innerText = editor_style.name;RemarkupElement.classList.add(editor_style.style_name);PreviewElement.classList.add(editor_style.style_name);};document.body.appendChild(EditorEnterBtn);document.body.appendChild(EditorSizeBtn);(() => {const findReplaceDiv = document.createElement("div");findReplaceDiv.innerHTML = `<div id="find-replace-box" class="find-replace-box"><input type="text" id="find-input" class="find-input" placeholder="Find"><div title="Case sensitive"><p>|Aa|</p><label class="switch"><input id="capital-switch" type="checkbox"><span class="slider round"></span></label></div><div title="Match whole word"><p>[Aa]</p><label class="switch"><input id="whole-word-switch" type="checkbox"><span class="slider round"></span></label></div><button id="find-btn" class="find-btn">Find</button><input type="text" id="replace-input" class="replace-input" placeholder="Replace"><div title="Replace All"><p>All</p><label class="switch"><input id="match-all-switch" type="checkbox"><span class="slider round"></span></label></div><button id="replace-btn" class="replace-btn">Replace</button></div>`;document.body.appendChild(findReplaceDiv);  const findReplaceStyles = `.find-replace-box {position: fixed;z-index: 100;bottom: 0;left: 0;padding: 5px;background-color: white;border: 1px solid #ccc;border-radius: 5px;}.find-replace-box div {display: inline-block;position: relative;bottom: -8px;}.find-input, .replace-input {padding: 2px;margin: 2px;}.find-btn, .replace-btn {padding: 2px;margin: 2px;}.switch {position: relative;display: inline-block;width: 32px;height: 18px;}  .switch input { opacity: 0;width: 0;height: 0;}  .slider {position: absolute;cursor: pointer;top: 0;left: 0;right: 0;bottom: 0;background-color: #ccc;-webkit-transition: .4s;transition: .4s;}.slider:before {position: absolute;content: "";height: 10px;width: 10px;left: 4px;bottom: 4px;background-color: white;-webkit-transition: .4s;transition: .4s;}  input:checked + .slider {background-color: #2196F3;}  input:focus + .slider {box-shadow: 0 0 1px #2196F3;  }  input:checked + .slider:before {-webkit-transform: translateX(13px);-ms-transform: translateX(13px);transform: translateX(13px);}  .slider.round {border-radius: 17px;}  .slider.round:before {border-radius: 50%;}`;const findReplaceStyleSheet = document.createElement("style");findReplaceStyleSheet.innerText = findReplaceStyles;document.head.appendChild(findReplaceStyleSheet);   const findBtn = document.getElementById("find-btn");const replaceBtn = document.getElementById("replace-btn");function getSearchRegex (findText) {   const caseSensitive = document.getElementById("capital-switch").checked;const wholeWord = document.getElementById("whole-word-switch").checked;const flags = caseSensitive ? "g" : "gi";return new RegExp(wholeWord ? `\\b${findText}\\b` : findText, flags);};findBtn.onclick = () => {var textarea = GetRemarkupElement()[1].querySelector("textarea");const findText = document.getElementById("find-input").value;const text = textarea.value;var searchRegex = getSearchRegex(findText);if (searchRegex.test(text)) {const position = text.search(searchRegex);textarea.setSelectionRange(position, position + findText.length);}};replaceBtn.onclick = () => {var textarea = GetRemarkupElement()[1].querySelector("textarea");const findText = document.getElementById("find-input").value;const replaceText = document.getElementById("replace-input").value;const matchAll = document.getElementById("match-all-switch").checked;var searchRegex = getSearchRegex(findText);const text = textarea.value;if (searchRegex.test(text)) {if (matchAll) {   textarea.value = text.replace(searchRegex, replaceText);} else {const position = text.search(searchRegex);textarea.setRangeText(replaceText, position, position + findText.length, 'select');}}};})();const insertText = (textarea, token) => {const position = textarea.selectionStart;   const start = textarea.selectionStart;const end = textarea.selectionEnd;const text = token + window.getSelection().toString() + token;textarea.setRangeText(text, start, end, 'select');};window.addEventListener("keydown", (event) => {if (document.activeElement.type == 'textarea' ){  let textarea = document.activeElement;if(event.ctrlKey && event.key === 'b') {insertText(textarea, '**');event.preventDefault(); } else if(event.ctrlKey && event.key == 'i') { insertText(textarea, '//');event.preventDefault(); } else if(event.ctrlKey && event.key == 'f') {} else if (event.key == '`') {insertText(textarea, '`');event.preventDefault();} else if(event.key == 'Tab') {var start = textarea.selectionStart;   while (start > 0 && textarea.value[start] != '\n') {start--;}const end = textarea.selectionEnd;const text = textarea.value;const selectedText = text.substring(start, end);const newText = selectedText.split('\n').map(line => '  ' + line).join('\n');textarea.setRangeText(newText, start, end, 'select');event.preventDefault(); }}});})()
        ```
        and then paste the link into the URL field of a new bookmark.
3. Done! Now you can click the bookmark to enable the full-screen editor mode (a button with the text "Edit" will appear in the top right corner of the page).


## Development
1. Remove all comments in the code.
2. Copy the code and paste it into the URL field of a new bookmark manually.
3. Copy the code from the URL field that you just pasted, and then paste it into this README.md file.
4. (Optional) You can remove the extra spaces `    ` used in indentation in the code to make it more compact.
5. Run the python script to automatically generate the inline js code
    ```bash
    python3 convert.py
    ```