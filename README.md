# Phabricator Remarkup Editor Plugin

This is a simple plugin that adds a button to the Phabricator Remarkup editor that allows you to edit the raw Remarkup text in full-screen mode.

## Security
- No additional package is required.
- Only inject CSS and JavaScript code into the current page.
- Volatile, the code will be removed after you refresh the page.
- No data is collected or sent to any server.

## Usage
- **!! Important !!** Currently, only `Task Maniphest`, `Events`, `Comment Editor`, and `New Comment` are supported.
- **!! Important !!** For the use case in `New Comment`, you need to type some text in the editor to show the preview panel before you can use the full-screen editor mode.
- **!! Important !!** For the use case in `Events`, the preview does not update automatically when you type in the editor. You need to re-open the full-screen editor mode to see the updated preview.

## Install on Your Bookmark
<!-- Set the bookmark row to visible -->
1. First, you need to make the bookmark row of your browser visible. In Chrome, you can do this by clicking the three-dot icon at the top right corner, selecting "Bookmarks" (書籤), and then selecting "Show bookmarks bar" (顯示書籤列).
2.  Drag this link 
<a href='javascript:(()=>{var editor_styles = `.editor-height-full {height: 100vh !important;}.editor-height-half {height: 50vh !important;}.editor-left-col {display: block;position: fixed;z-index: 15;left: 0;bottom: 0;width: 50%;iiheight: 100vh;}.editor-left-col textarea {display: block !important;height: 100% !important;background-color: rgba(250,250,250,1.0) !important;}.editor-right-col {display: block;position: fixed;z-index: 15;left: 50%;bottom: 0;width: 50%;overflow-y: scroll;background-color: rgba(250,250,250,1.0);}.editor-btn {z-index: 20;position: fixed;padding: 0;width: 50px;height: 50px;border-radius: 50%;opacity: 0.7;}.editor-btn p {text-align: center;}#editor-enter-btn {right: 50px;top: 50px;}#editor-size-btn {right: 120px;top: 50px;}.editor-move-down {position: fixed;bottom: 0;}`;var styleSheet = document.createElement("style");styleSheet.innerText = editor_styles;document.head.appendChild(styleSheet);function SetRemarkupPreview(preview_state) {const num_btn = document.querySelectorAll("div.fa-eye").length;var PreviewBtn = document.querySelectorAll("div.fa-eye")[num_btn-1].parentElement;if (PreviewBtn == null) return null;const current_state = PreviewBtn.classList.contains("preview-active");if (preview_state != current_state) {PreviewBtn.click();}return PreviewBtn;}class EditorMode {static None = new EditorMode("None");static Normal = new EditorMode("Normal");static Task = new EditorMode("Task");static Event = new EditorMode("Event");static BlockEditor = new EditorMode("BlockEditor");static NewComment = new EditorMode("NewComment");constructor(name) {this.name = name;}}class EditorStyle {static Full = new EditorStyle("Full", "editor-height-full");static Half = new EditorStyle("Half", "editor-height-half");constructor(name, style_name) {this.name = name;this.style_name = style_name;}}function GetRemarkupElement() {var assist_bar = document.getElementsByClassName("remarkup-assist-bar");const edit_mode = (assist_bar.length > 1) ? EditorMode.BlockEditor : EditorMode.Normal;var targetRemarkUpElement = assist_bar[assist_bar.length-1].parentElement;targetRemarkUpElement.querySelector("textarea").focus();return [edit_mode, targetRemarkUpElement];}function GetPreviewElement(edit_mode) {if (edit_mode.name === EditorMode.Normal.name) {if (document.getElementsByClassName("phui-comment-preview-view").length > 0) {return document.getElementsByClassName("phui-comment-preview-view")[0].querySelector("div.phui-timeline-view");} else if (document.getElementsByClassName("phui-remarkup-preview").length > 0) {return document.getElementsByClassName("phui-remarkup-preview")[0];}}if (SetRemarkupPreview(true) !== null) {if (document.getElementsByClassName("remarkup-inline-preview").length > 0)return document.getElementsByClassName("remarkup-inline-preview")[0];} return null;}function HideOriginalEditor(hide) {var mask = document.getElementsByClassName("jx-mask")[0];var originalEditor = document.getElementsByClassName("jx-client-dialog")[0];if (hide) {mask.style.display = "none";originalEditor.classList.add("editor-move-down");} else {mask.style.display = "block";originalEditor.classList.remove("editor-move-down");}}var editor_mode = "normal";var editor_style = EditorStyle.Full;var EditorEnterBtn = document.createElement("button");EditorEnterBtn.setAttribute("id", "editor-enter-btn");EditorEnterBtn.classList.add("editor-btn");EditorEnterBtn.innerHTML = `<p id="editor-text">Edit</p>`;EditorEnterBtn.onclick = (evt)=>{var [edit_mode, RemarkupElement] = GetRemarkupElement();var PreviewElement = GetPreviewElement(edit_mode);if (RemarkupElement === null || PreviewElement === null) {alert("Current page does not support editor mode!");return;}if (editor_mode === "normal") {editor_mode = "editor";RemarkupElement.classList.add("editor-left-col");RemarkupElement.classList.add(editor_style.style_name);RemarkupElement.classList.remove("remarkup-preview-active");PreviewElement.classList.add("editor-right-col");PreviewElement.classList.add(editor_style.style_name);document.getElementById("editor-text").innerText = "Back";if (edit_mode === EditorMode.BlockEditor) {HideOriginalEditor(true);}} else {editor_mode = "normal";RemarkupElement.classList.remove("editor-left-col");RemarkupElement.classList.remove(editor_style.style_name);PreviewElement.classList.remove("editor-right-col");PreviewElement.classList.remove(editor_style.style_name);document.getElementById("editor-text").innerText = "Edit";SetRemarkupPreview(false);if (edit_mode === EditorMode.BlockEditor) {HideOriginalEditor(false);}}};var EditorSizeBtn = document.createElement("button");EditorSizeBtn.setAttribute("id", "editor-size-btn");EditorSizeBtn.classList.add("editor-btn");EditorSizeBtn.innerHTML = `<p id="editor-size-text">Half<br>Size</p>`;EditorSizeBtn.onclick = (evt)=>{var [edit_mode, RemarkupElement] = GetRemarkupElement();var PreviewElement = GetPreviewElement(edit_mode);RemarkupElement.classList.remove(editor_style.style_name);PreviewElement.classList.remove(editor_style.style_name);editor_style = (editor_style === EditorStyle.Full) ? EditorStyle.Half : EditorStyle.Full;EditorSizeBtn.innerText = editor_style.name;RemarkupElement.classList.add(editor_style.style_name);PreviewElement.classList.add(editor_style.style_name);};document.body.appendChild(EditorEnterBtn);document.body.appendChild(EditorSizeBtn);})()'>Edit</a>,
to the bookmark bar of your browser. 
    - (Alternatively), Right-click on the space of the bookmark bar. Click "Add page" (新增網頁).
    - You can copy the following code: 
        ```
        javascript:(()=>{var editor_styles = `.editor-height-full {height: 100vh !important;}.editor-height-half {height: 50vh !important;}.editor-left-col {display: block;position: fixed;z-index: 15;left: 0;bottom: 0;width: 50%;iiheight: 100vh;}.editor-left-col textarea {display: block !important;height: 100% !important;background-color: rgba(250,250,250,1.0) !important;}.editor-right-col {display: block;position: fixed;z-index: 15;left: 50%;bottom: 0;width: 50%;overflow-y: scroll;background-color: rgba(250,250,250,1.0);}.editor-btn {z-index: 20;position: fixed;padding: 0;width: 50px;height: 50px;border-radius: 50%;opacity: 0.7;}.editor-btn p {text-align: center;}#editor-enter-btn {right: 50px;top: 50px;}#editor-size-btn {right: 120px;top: 50px;}.editor-move-down {position: fixed;bottom: 0;}`;var styleSheet = document.createElement("style");styleSheet.innerText = editor_styles;document.head.appendChild(styleSheet);function SetRemarkupPreview(preview_state) {const num_btn = document.querySelectorAll("div.fa-eye").length;var PreviewBtn = document.querySelectorAll("div.fa-eye")[num_btn-1].parentElement;if (PreviewBtn == null) return null;const current_state = PreviewBtn.classList.contains("preview-active");if (preview_state != current_state) {PreviewBtn.click();}return PreviewBtn;}class EditorMode {static None = new EditorMode("None");static Normal = new EditorMode("Normal");static Task = new EditorMode("Task");static Event = new EditorMode("Event");static BlockEditor = new EditorMode("BlockEditor");static NewComment = new EditorMode("NewComment");constructor(name) {this.name = name;}}class EditorStyle {static Full = new EditorStyle("Full", "editor-height-full");static Half = new EditorStyle("Half", "editor-height-half");constructor(name, style_name) {this.name = name;this.style_name = style_name;}}function GetRemarkupElement() {var assist_bar = document.getElementsByClassName("remarkup-assist-bar");const edit_mode = (assist_bar.length > 1) ? EditorMode.BlockEditor : EditorMode.Normal;var targetRemarkUpElement = assist_bar[assist_bar.length-1].parentElement;targetRemarkUpElement.querySelector("textarea").focus();return [edit_mode, targetRemarkUpElement];}function GetPreviewElement(edit_mode) {if (edit_mode.name === EditorMode.Normal.name) {if (document.getElementsByClassName("phui-comment-preview-view").length > 0) {return document.getElementsByClassName("phui-comment-preview-view")[0].querySelector("div.phui-timeline-view");} else if (document.getElementsByClassName("phui-remarkup-preview").length > 0) {return document.getElementsByClassName("phui-remarkup-preview")[0];}}if (SetRemarkupPreview(true) !== null) {if (document.getElementsByClassName("remarkup-inline-preview").length > 0)return document.getElementsByClassName("remarkup-inline-preview")[0];} return null;}function HideOriginalEditor(hide) {var mask = document.getElementsByClassName("jx-mask")[0];var originalEditor = document.getElementsByClassName("jx-client-dialog")[0];if (hide) {mask.style.display = "none";originalEditor.classList.add("editor-move-down");} else {mask.style.display = "block";originalEditor.classList.remove("editor-move-down");}}var editor_mode = "normal";var editor_style = EditorStyle.Full;var EditorEnterBtn = document.createElement("button");EditorEnterBtn.setAttribute("id", "editor-enter-btn");EditorEnterBtn.classList.add("editor-btn");EditorEnterBtn.innerHTML = `<p id="editor-text">Edit</p>`;EditorEnterBtn.onclick = (evt)=>{var [edit_mode, RemarkupElement] = GetRemarkupElement();var PreviewElement = GetPreviewElement(edit_mode);if (RemarkupElement === null || PreviewElement === null) {alert("Current page does not support editor mode!");return;}if (editor_mode === "normal") {editor_mode = "editor";RemarkupElement.classList.add("editor-left-col");RemarkupElement.classList.add(editor_style.style_name);RemarkupElement.classList.remove("remarkup-preview-active");PreviewElement.classList.add("editor-right-col");PreviewElement.classList.add(editor_style.style_name);document.getElementById("editor-text").innerText = "Back";if (edit_mode === EditorMode.BlockEditor) {HideOriginalEditor(true);}} else {editor_mode = "normal";RemarkupElement.classList.remove("editor-left-col");RemarkupElement.classList.remove(editor_style.style_name);PreviewElement.classList.remove("editor-right-col");PreviewElement.classList.remove(editor_style.style_name);document.getElementById("editor-text").innerText = "Edit";SetRemarkupPreview(false);if (edit_mode === EditorMode.BlockEditor) {HideOriginalEditor(false);}}};var EditorSizeBtn = document.createElement("button");EditorSizeBtn.setAttribute("id", "editor-size-btn");EditorSizeBtn.classList.add("editor-btn");EditorSizeBtn.innerHTML = `<p id="editor-size-text">Half<br>Size</p>`;EditorSizeBtn.onclick = (evt)=>{var [edit_mode, RemarkupElement] = GetRemarkupElement();var PreviewElement = GetPreviewElement(edit_mode);RemarkupElement.classList.remove(editor_style.style_name);PreviewElement.classList.remove(editor_style.style_name);editor_style = (editor_style === EditorStyle.Full) ? EditorStyle.Half : EditorStyle.Full;EditorSizeBtn.innerText = editor_style.name;RemarkupElement.classList.add(editor_style.style_name);PreviewElement.classList.add(editor_style.style_name);};document.body.appendChild(EditorEnterBtn);document.body.appendChild(EditorSizeBtn);})()
        ```
        and then paste the link into the URL field of a new bookmark.
3. Done! Now you can click the bookmark to enable the full-screen editor mode (a button with the text "Edit" will appear in the top right corner of the page).


## Development
1. Remove all comments in the code.
2. Copy the code and paste it into the URL field of a new bookmark manually.
3. Copy the code from the URL field that you just pasted, and then paste it into this README.md file.
4. (Optional) You can remove the extra spaces `    ` used in indentation in the code to make it more compact.
5. Run the python script to automatically generate the inline js code
    ```bash
    python3 convert.py
    ```